<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Astrologer Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.pubnub.com/sdk/javascript/pubnub.7.2.0.min.js"></script>

<style>
body{margin:0;font-family:system-ui;background:#f6f6f8;height:100vh;display:flex}
.sidebar{width:260px;background:#fff;padding:14px;border-right:1px solid #ddd}
.status{font-size:13px;font-weight:600}
.online{color:green}
.offline{color:red}

.chat{flex:1;display:flex;flex-direction:column}
.chatBody{flex:1;padding:14px;overflow-y:auto}
.msg{padding:10px 12px;border-radius:12px;margin-bottom:8px;max-width:80%}
.customer{background:#fff}
.me{background:#ffe6d5;margin-left:auto}
.system{background:#fff3cd}

.time{font-size:11px;opacity:.6;margin-top:4px}

.controls{display:flex;gap:8px;padding:12px;background:#fff}
input{flex:1;padding:10px;border-radius:20px}
button{padding:10px 16px;border-radius:20px;background:#F8CFAF;border:none;font-weight:700}
</style>
</head>

<body>

<div class="sidebar">
  <h3>Astrologer: Gautam</h3>
  <div id="custStatus" class="status offline">‚óè Customer Offline</div>
  <div id="detailsBox"></div>
</div>

<div class="chat">
  <div id="chatBody" class="chatBody"></div>
  <div class="controls">
    <input id="reply" placeholder="Reply‚Ä¶">
    <button onclick="send()">Send</button>
  </div>
</div>

<script>
const CHANNEL="astro_gautam_chat";
const uuid="Astrologer_Gautam";

const pubnub=new PubNub({
  publishKey:"pub-c-a90a128a-4e77-4b6a-bbb3-59d0fb688ddc",
  subscribeKey:"sub-c-1b514e35-fab1-4baf-88f1-6b628ab7e9c2",
  uuid
});

pubnub.subscribe({channels:[CHANNEL],withPresence:true});

/* PRESENCE FIX */
pubnub.hereNow({channels:[CHANNEL]},(s,r)=>{
  custStatus.textContent =
    r.channels[CHANNEL]?.occupancy>1
    ? "‚óè Customer Online"
    : "‚óè Customer Offline";
  custStatus.className="status "+(r.channels[CHANNEL]?.occupancy>1?"online":"offline");
});

pubnub.addListener({
  message:e=>{
    const m=e.message;
    if(m.sender===uuid)return;

    if(m.text.startsWith("üßæ")){
      detailsBox.innerHTML="<pre>"+m.text+"</pre>";
      return;
    }

    addMsg(m.sender+": "+m.text,"customer",m.ts);
  },
  presence:e=>{
    if(e.uuid.startsWith("Customer_")){
      custStatus.textContent="‚óè Customer "+(e.action==="join"?"Online":"Offline");
      custStatus.className="status "+(e.action==="join"?"online":"offline");
    }
  }
});

function send(){
  const t=reply.value.trim();
  if(!t)return;
  reply.value="";
  addMsg("You: "+t,"me",Date.now());

  pubnub.publish({
    channel:CHANNEL,
    message:{sender:uuid,text:t,ts:Date.now()}
  });
}

function addMsg(text,type,ts){
  const d=document.createElement("div");
  d.className="msg "+type;
  d.innerHTML=text+
    `<div class="time">${new Date(ts).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</div>`;
  chatBody.appendChild(d);
  chatBody.scrollTop=chatBody.scrollHeight;
}
</script>

</body>
</html>

