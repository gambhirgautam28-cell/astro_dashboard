<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Astrologer Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.pubnub.com/sdk/javascript/pubnub.7.2.0.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{margin:0;font-family:system-ui;display:flex;height:100vh}
.sidebar{width:260px;background:#fff;padding:14px}
.chat{flex:1;display:flex;flex-direction:column}
.chatBody{flex:1;padding:12px;overflow:auto}
.msg{padding:10px;border-radius:10px;margin-bottom:6px;max-width:80%}
.customer{background:#fff}
.me{background:#ffe6d5;margin-left:auto}
.controls{display:flex;padding:10px;background:#fff}
</style>
</head>

<body>

<div class="sidebar">
  <h3>Astrologer Gautam</h3>
  <div id="sessions"></div>
</div>

<div class="chat">
  <div id="chatBody" class="chatBody"></div>
  <div class="controls">
    <input id="reply">
    <button onclick="send()">Send</button>
  </div>
</div>

<script>
const firebaseConfig = {
  /* YOUR FIREBASE CONFIG */
};
firebase.initializeApp(firebaseConfig);
const db=firebase.firestore();

const astrologerId="Gautam";
let activeSession=null;
let pubnub;

/* ---------------- LOAD SESSIONS ---------------- */
(async function(){
  const snap = await db
    .collection("sessions")
    .where("astrologerId","==",astrologerId)
    .where("status","==","active")
    .get();

  const channels=[];
  snap.forEach(d=>{
    const s=d.data();
    channels.push(s.channel);
    addSessionButton(d.id,s.channel);
  });

  pubnub=new PubNub({
    publishKey:"pub-c-a90a128a-4e77-4b6a-bbb3-59d0fb688ddc",
    subscribeKey:"sub-c-1b514e35-fab1-4baf-88f1-6b628ab7e9c2",
    uuid:astrologerId
  });

  pubnub.subscribe({channels});

  pubnub.addListener({
    message:e=>{
      if(e.channel!==activeSession) return;
      const m=e.message;
      addMsg(m.text,"customer",m.ts);
    }
  });
})();

/* ---------------- UI ---------------- */
function addSessionButton(id,channel){
  const b=document.createElement("button");
  b.textContent=id;
  b.onclick=()=>{
    activeSession=channel;
    chatBody.innerHTML="";
  };
  sessions.appendChild(b);
}

function addMsg(text,type,ts){
  const d=document.createElement("div");
  d.className="msg "+type;
  d.innerHTML=text+`<div style="font-size:11px">${new Date(ts).toLocaleTimeString()}</div>`;
  chatBody.appendChild(d);
  chatBody.scrollTop=chatBody.scrollHeight;
}

/* ---------------- SEND ---------------- */
function send(){
  if(!activeSession) return alert("Select session");
  const t=reply.value.trim();
  if(!t)return;
  reply.value="";
  addMsg(t,"me",Date.now());

  pubnub.publish({
    channel:activeSession,
    message:{
      senderId:astrologerId,
      text:t,
      ts:Date.now()
    }
  });
}
</script>

</body>
</html>


