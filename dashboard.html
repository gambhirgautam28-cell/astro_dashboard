<!doctype html>
<html>
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Astrologer Dashboard — Gautam</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root{--bg:#f6f6f8;--card:#fff;--accent:#F8CFAF}
  html,body{height:100%;margin:0;font-family:Inter,system-ui;background:var(--bg)}
  .wrap{display:flex;height:100vh;padding:18px;box-sizing:border-box;gap:18px}
  .panel{background:var(--card);border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.06);overflow:hidden}
  .sidebar{width:320px;display:flex;flex-direction:column}
  .head{padding:14px;display:flex;align-items:center;gap:12px;border-bottom:1px solid #f0f0f2;background:linear-gradient(90deg,#fff,#fbfbfb)}
  .avatar{width:46px;height:46px;border-radius:10px;background:#eee;object-fit:cover}
  .who{font-weight:700}
  .list{padding:12px;overflow:auto;flex:1;background:#fff}
  .session-item{padding:10px;border-radius:10px;margin-bottom:8px;display:flex;gap:8px;align-items:center;cursor:pointer;border:1px solid transparent}
  .session-item:hover{background:#fafafa;border-color:#f0f0f2}
  .chat-area{flex:1;display:flex;flex-direction:column}
  .chat-header{padding:14px;border-bottom:1px solid #f0f0f2;background:#fff}
  .chat-body{flex:1;padding:16px;background:linear-gradient(180deg,#e5ddd5,#e3dacb);overflow:auto;display:flex;flex-direction:column;gap:10px}
  .bubble{max-width:72%;padding:10px 12px;border-radius:12px}
  .me{align-self:flex-end;background:#eefbe9}
  .them{align-self:flex-start;background:#fff}
  .meta{font-size:12px;color:#444}
  .composer{display:flex;gap:10px;padding:12px;border-top:1px solid #f0f0f2;background:#fff}
  .input{flex:1;padding:10px;border-radius:999px;border:1px solid #eee;background:#fafafa}
  .send{padding:10px 14px;border-radius:999px;border:0;background:linear-gradient(90deg,#fb8b55,#f8cfa7);font-weight:700;cursor:pointer}
  @media (max-width:880px){ .sidebar{display:none} }
</style>
</head>
<body>
<div class="wrap">
  <div class="panel sidebar">
    <div class="head">
      <div class="avatar" id="astroAvatar" style="background-image:url('https://via.placeholder.com/150?text=Upload');background-size:cover"></div>
      <div>
        <div id="astroUser" class="who">Gautam</div>
        <div id="astroOnline" style="font-size:13px;color:#666">Online</div>
      </div>
      <div style="margin-left:auto"><button id="logout">Logout</button></div>
    </div>

    <div style="padding:12px;border-bottom:1px solid #f0f0f2">Active Sessions</div>
    <div id="sessions" class="list"><div style="color:#6b7280;padding:12px">Waiting for customers…</div></div>
  </div>

  <div class="panel chat-area" style="flex:1;display:flex;flex-direction:column">
    <div class="chat-header">
      <div id="chatTitle">Select a session</div>
      <div id="chatSubtitle" style="font-size:13px;color:#666">No session selected</div>
    </div>

    <div id="chatBody" class="chat-body"><div style="opacity:.9">No messages yet</div></div>

    <div class="composer" id="composer" style="display:none">
      <input id="reply" class="input" placeholder="Reply to customer..."/>
      <button id="send" class="send">Send</button>
    </div>
  </div>
</div>

<script src="https://cdn.pubnub.com/sdk/javascript/pubnub.7.2.0.min.js"></script>
<script>
/* ---------- CONFIG ---------- */
const PUB = "pub-c-a90a128a-4e77-4b6a-bbb3-59d0fb688ddc";
const SUB = "sub-c-1b514e35-fab1-4baf-88f1-6b628ab7e9c2";
const ASTRO = "Gautam"; // astrologer key (login determines this)

/* ---------- Auth (simple client-side session created by login page) */
(function requireAuth(){
  try{
    const s = JSON.parse(localStorage.getItem('astro_session')||'null');
    if(!s || !s.user || s.user !== ASTRO){ window.location.href = 'login.html'; return; }
    document.getElementById('astroUser').textContent = s.user;
  }catch(e){ window.location.href='login.html'; return; }
})();

/* ---------- PubNub init ---------- */
const uuid = 'astro_' + ASTRO + '_' + Math.random().toString(36).slice(2,6);
const pubnub = new PubNub({ publishKey: PUB, subscribeKey: SUB, uuid });

const CONTROL = `astro_${ASTRO}_control`; // customers announce join here

/* state */
const sessions = {}; // sessionId -> { uuid, messages:[] }
let selected = null;

/* UI refs */
const sessionsEl = document.getElementById('sessions');
const chatBody = document.getElementById('chatBody');
const chatTitle = document.getElementById('chatTitle');
const chatSubtitle = document.getElementById('chatSubtitle');
const composer = document.getElementById('composer');
const replyInput = document.getElementById('reply');
const sendBtn = document.getElementById('send');

/* listen for join/leave and messages */
pubnub.addListener({
  message: (evt) => {
    const m = evt.message;
    // messages on any channel (we also subscribe to CONTROL)
    if(m && m.type === 'join' && m.astro === ASTRO){
      // new customer announced: m.channel contains their session channel
      const sid = m.channel;
      if(!sessions[sid]){ sessions[sid] = { id: sid, uuid: m.uuid, messages: [], lastTs: m.ts||Date.now() }; addSession(sessions[sid]); }
      else { sessions[sid].lastTs = m.ts||Date.now(); refreshList(); }
    } else if(m && m.type === 'leave' && m.astro === ASTRO){
      const sid = m.channel;
      if(sessions[sid]) { sessions[sid].left = true; refreshList(); }
    } else if(m && m.sender){
      // real chat message from a session channel
      const channel = evt.channel;
      if(!sessions[channel]){ sessions[channel] = { id: channel, uuid: m.sender, messages: [] }; addSession(sessions[channel]); }
      sessions[channel].messages.push(m);
      if(selected === channel){ appendMsg(m, 'them'); } else { refreshList(); }
    }
  },
  signal: (evt) => {
    // typing signals if needed
    const ch = evt.channel; const m = evt.message;
    if(m && m.type==='typing' && selected === ch){
      // show typing statue temporarily
      // (left as simple text in subtitle)
      document.getElementById('chatSubtitle').textContent = m.isTyping ? 'Customer is typing…' : '';
    }
  }
});

/* subscribe CONTROL to discover customers */
pubnub.subscribe({ channels: [CONTROL] });

/* add session item */
function addSession(s){
  if(sessionsEl.firstChild && sessionsEl.firstChild.textContent.includes('Waiting for customers')) sessionsEl.innerHTML='';
  const el = document.createElement('div');
  el.className = 'session-item';
  el.id = 'session_'+encodeURIComponent(s.id);
  el.innerHTML = `<div style="flex:1"><div style="font-weight:700">Customer • ${s.uuid || s.id.split('_').pop()}</div><div style="font-size:12px;color:#666">Joined ${new Date(s.lastTs).toLocaleTimeString()}</div></div>`;
  el.onclick = ()=> openSession(s.id);
  sessionsEl.prepend(el);
}

/* refresh (simple) */
function refreshList(){
  const arr = Object.values(sessions).sort((a,b)=> (b.lastTs||0)-(a.lastTs||0));
  sessionsEl.innerHTML = '';
  if(arr.length===0){ sessionsEl.innerHTML = '<div style="color:#6b7280;padding:12px">Waiting for customers…</div>'; return; }
  arr.forEach(addSession);
}

/* open session: subscribe to that channel and load history */
function openSession(sessionId){
  selected = sessionId;
  chatBody.innerHTML = '';
  chatTitle.textContent = 'Session: ' + sessionId.split('_').pop();
  chatSubtitle.textContent = sessionId;
  composer.style.display = 'flex';
  // subscribe to session channel
  pubnub.subscribe({ channels: [sessionId] });

  // load history
  pubnub.history({ channel: sessionId, count: 100 }, (st,res) => {
    chatBody.innerHTML = '';
    const msgs = (res.messages||[]).map(m=>m.entry);
    msgs.forEach(m => { appendMsg(m, m.sender === pubnub.getUUID() ? 'me' : 'them'); });
    chatBody.scrollTop = chatBody.scrollHeight;
  });
}

/* append message bubble */
function appendMsg(m, who){
  const b = document.createElement('div');
  b.className = 'bubble ' + (who==='me' ? 'me' : 'them');
  b.textContent = m.text || m.message || JSON.stringify(m);
  const meta = document.createElement('div'); meta.className='meta';
  meta.textContent = new Date((m.ts||Date.now())).toLocaleTimeString();
  chatBody.appendChild(b); chatBody.appendChild(meta);
  chatBody.scrollTop = chatBody.scrollHeight;
}

/* send reply */
sendBtn.onclick = () => {
  const text = replyInput.value.trim(); if(!text || !selected) return;
  const payload = { id: Date.now().toString(36), sender: pubnub.getUUID(), text, ts: Date.now(), status:'sent' };
  pubnub.publish({ channel: selected, message: payload }, (s,r) => {
    if(!s.error){ appendMsg(payload, 'me'); replyInput.value=''; }
  });
};

/* typing */
let _t;
replyInput.addEventListener('input', ()=> {
  if(!selected) return;
  pubnub.signal({ channel: selected, message: { type:'typing', from: pubnub.getUUID(), isTyping:true }});
  clearTimeout(_t); _t = setTimeout(()=> {
    pubnub.signal({ channel: selected, message: { type:'typing', from: pubnub.getUUID(), isTyping:false }});
  }, 900);
});

/* initial refresh */
refreshList();

/* logout */
document.getElementById('logout').addEventListener('click', ()=> {
  localStorage.removeItem('astro_session'); window.location.href='login.html';
});
</script>
</body>
</html>

